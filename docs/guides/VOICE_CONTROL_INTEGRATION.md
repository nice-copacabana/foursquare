# è¯­éŸ³æ§åˆ¶åŠŸèƒ½é›†æˆæŒ‡å—

<!-- Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-11-24 -->
<!-- Task: åˆ›å»ºè¯­éŸ³æ§åˆ¶åŠŸèƒ½é›†æˆè¯´æ˜æ–‡æ¡£ -->

## ğŸ“‹ æ¦‚è¿°

è¯­éŸ³æ§åˆ¶åŠŸèƒ½å…è®¸ç©å®¶é€šè¿‡è¯­éŸ³æŒ‡ä»¤æ§åˆ¶æ¸¸æˆï¼Œæä¾›å…¨æ–°çš„äº¤äº’ä½“éªŒã€‚æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•å®Œæˆè¯­éŸ³åŠŸèƒ½çš„é›†æˆå’Œé…ç½®ã€‚

**å½“å‰çŠ¶æ€**: âœ… åŸºç¡€æ¶æ„å·²å®Œæˆï¼Œâš ï¸ éœ€æ·»åŠ ä¾èµ–å’Œé…ç½®

## ğŸ—ï¸ å·²å®Œæˆçš„åŸºç¡€æ¶æ„

### 1. æ ¸å¿ƒæœåŠ¡

| æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| è¯­éŸ³è¯†åˆ«æœåŠ¡ | `lib/services/voice_recognition_service.dart` | âœ… å®Œæˆ | è¯­éŸ³è½¬æ–‡å­— |
| è¯­éŸ³åˆæˆæœåŠ¡ | `lib/services/voice_synthesis_service.dart` | âœ… å®Œæˆ | æ–‡å­—è½¬è¯­éŸ³ |
| è¯­éŸ³å‘½ä»¤è§£æå™¨ | `lib/ai/voice_command_parser.dart` | âœ… å®Œæˆ | æŒ‡ä»¤è§£æ |

### 2. åŠŸèƒ½ç‰¹æ€§

#### è¯­éŸ³è¯†åˆ«æœåŠ¡
- âœ… åˆå§‹åŒ–ç®¡ç†
- âœ… å¼€å§‹/åœæ­¢ç›‘å¬
- âœ… æƒé™æ£€æŸ¥
- âœ… å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡/æ—¥æ–‡ï¼‰
- âœ… ç»“æœå›è°ƒæœºåˆ¶

#### è¯­éŸ³åˆæˆæœåŠ¡
- âœ… æ–‡æœ¬æ’­æŠ¥
- âœ… éŸ³é‡/éŸ³è°ƒ/è¯­é€Ÿæ§åˆ¶
- âœ… é˜Ÿåˆ—ç®¡ç†
- âœ… å¤šè¯­è¨€æ”¯æŒ

#### è¯­éŸ³å‘½ä»¤è§£æå™¨
- âœ… ä¼ ç»Ÿåæ ‡è§£æï¼ˆ"æ¨ª1ç«–2"ï¼‰
- âœ… å›½é™…åæ ‡è§£æï¼ˆ"A1", "B2"ï¼‰
- âœ… æ–¹å‘åæ ‡è§£æï¼ˆ"å·¦ä¸Š"ã€"ä¸­é—´"ï¼‰
- âœ… è‡ªç„¶è¯­è¨€è§£æï¼ˆ"ç§»åŠ¨åˆ°æ¨ª2ç«–3"ï¼‰
- âœ… æ¨¡ç³ŠåŒ¹é…æ”¯æŒ

## ğŸš€ å®Œæ•´é›†æˆæ­¥éª¤

### ç¬¬1æ­¥ï¼šæ·»åŠ ä¾èµ–

ç¼–è¾‘ `pubspec.yaml`ï¼Œæ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

```yaml
dependencies:
  # ç°æœ‰ä¾èµ–...
  
  # è¯­éŸ³åŠŸèƒ½ä¾èµ–
  speech_to_text: ^6.3.0     # è¯­éŸ³è¯†åˆ«
  flutter_tts: ^3.8.0        # è¯­éŸ³åˆæˆ
  permission_handler: ^11.0.1  # æƒé™ç®¡ç†ï¼ˆå¯é€‰ï¼‰
```

ç„¶åè¿è¡Œï¼š
```bash
flutter pub get
```

### ç¬¬2æ­¥ï¼šé…ç½®å¹³å°æƒé™

#### Androidé…ç½®

ç¼–è¾‘ `android/app/src/main/AndroidManifest.xml`ï¼š

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- æ·»åŠ æƒé™ -->
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.INTERNET" />
    
    <!-- å¦‚æœéœ€è¦è¯­éŸ³è¯†åˆ«ç½‘ç»œæœåŠ¡ -->
    <queries>
        <intent>
            <action android:name="android.speech.RecognitionService" />
        </intent>
    </queries>
    
    <application ...>
        <!-- ç°æœ‰é…ç½® -->
    </application>
</manifest>
```

#### iOSé…ç½®

ç¼–è¾‘ `ios/Runner/Info.plist`ï¼š

```xml
<dict>
    <!-- ç°æœ‰é…ç½® -->
    
    <!-- éº¦å…‹é£æƒé™è¯´æ˜ -->
    <key>NSMicrophoneUsageDescription</key>
    <string>éœ€è¦ä½¿ç”¨éº¦å…‹é£è¿›è¡Œè¯­éŸ³æ§åˆ¶</string>
    
    <!-- è¯­éŸ³è¯†åˆ«æƒé™è¯´æ˜ -->
    <key>NSSpeechRecognitionUsageDescription</key>
    <string>éœ€è¦ä½¿ç”¨è¯­éŸ³è¯†åˆ«åŠŸèƒ½æ§åˆ¶æ¸¸æˆ</string>
</dict>
```

### ç¬¬3æ­¥ï¼šå–æ¶ˆæœåŠ¡ä»£ç æ³¨é‡Š

#### 3.1 ç¼–è¾‘ `voice_recognition_service.dart`

æ‰¾åˆ°æ‰€æœ‰ `/// TODO:` æ ‡è®°ï¼Œå–æ¶ˆæ³¨é‡Šå¹¶å¯¼å…¥ä¾èµ–ï¼š

```dart
// æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import 'package:speech_to_text/speech_to_text.dart';

// å–æ¶ˆæ³¨é‡Šå­—æ®µ
final SpeechToText _speech = SpeechToText();

// å–æ¶ˆæ³¨é‡Šinitializeæ–¹æ³•ä¸­çš„ä»£ç 
bool available = await _speech.initialize(
  onError: (error) => _handleError(error.errorMsg),
  onStatus: (status) => _handleStatus(status),
);
// ... ç­‰ç­‰
```

#### 3.2 ç¼–è¾‘ `voice_synthesis_service.dart`

```dart
// æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import 'package:flutter_tts/flutter_tts.dart';

// å–æ¶ˆæ³¨é‡Šå­—æ®µ
final FlutterTts _tts = FlutterTts();

// å–æ¶ˆæ³¨é‡Šåˆå§‹åŒ–ä»£ç 
await _tts.setLanguage(_language);
await _tts.setVolume(_volume);
// ... ç­‰ç­‰
```

### ç¬¬4æ­¥ï¼šé›†æˆåˆ°GameBloc

#### 4.1 æ·»åŠ è¯­éŸ³ç›¸å…³äº‹ä»¶

ç¼–è¾‘ `lib/bloc/game_event.dart`ï¼Œæ·»åŠ ï¼š

```dart
/// åˆ‡æ¢è¯­éŸ³æ§åˆ¶
class VoiceControlToggledEvent extends GameEvent {
  final bool enabled;
  
  const VoiceControlToggledEvent(this.enabled);
  
  @override
  List<Object?> get props => [enabled];
}

/// æ¥æ”¶è¯­éŸ³å‘½ä»¤
class VoiceCommandReceivedEvent extends GameEvent {
  final String command;
  
  const VoiceCommandReceivedEvent(this.command);
  
  @override
  List<Object?> get props => [command];
}

/// è¯·æ±‚è¯­éŸ³æ’­æŠ¥
class VoiceAnnouncementRequestedEvent extends GameEvent {
  final String text;
  
  const VoiceAnnouncementRequestedEvent(this.text);
  
  @override
  List<Object?> get props => [text];
}
```

#### 4.2 æ›´æ–°GameState

ç¼–è¾‘ `lib/bloc/game_state.dart`ï¼Œæ·»åŠ å­—æ®µï¼š

```dart
class GamePlaying extends GameState {
  // ç°æœ‰å­—æ®µ...
  
  /// è¯­éŸ³æ§åˆ¶æ˜¯å¦å¼€å¯
  final bool isVoiceControlEnabled;
  
  /// è¯­éŸ³è¯†åˆ«çŠ¶æ€
  final VoiceRecognitionStatus voiceRecognitionStatus;
  
  /// æœ€åè¯†åˆ«çš„å‘½ä»¤
  final String? lastVoiceCommand;
  
  const GamePlaying({
    // ç°æœ‰å‚æ•°...
    this.isVoiceControlEnabled = false,
    this.voiceRecognitionStatus = VoiceRecognitionStatus.notInitialized,
    this.lastVoiceCommand,
  });
  
  @override
  GamePlaying copyWith({
    // ç°æœ‰å‚æ•°...
    bool? isVoiceControlEnabled,
    VoiceRecognitionStatus? voiceRecognitionStatus,
    String? lastVoiceCommand,
    bool clearLastVoiceCommand = false,
  }) {
    return GamePlaying(
      // ç°æœ‰å¤åˆ¶é€»è¾‘...
      isVoiceControlEnabled: isVoiceControlEnabled ?? this.isVoiceControlEnabled,
      voiceRecognitionStatus: voiceRecognitionStatus ?? this.voiceRecognitionStatus,
      lastVoiceCommand: clearLastVoiceCommand ? null : (lastVoiceCommand ?? this.lastVoiceCommand),
    );
  }
}
```

#### 4.3 åœ¨GameBlocä¸­æ·»åŠ æœåŠ¡

ç¼–è¾‘ `lib/bloc/game_bloc.dart`ï¼š

```dart
import '../services/voice_recognition_service.dart';
import '../services/voice_synthesis_service.dart';
import '../ai/voice_command_parser.dart';

class GameBloc extends Bloc<GameEvent, GameState> {
  // ç°æœ‰æœåŠ¡...
  final VoiceRecognitionService _voiceRecognitionService;
  final VoiceSynthesisService _voiceSynthesisService;
  
  GameBloc({
    // ç°æœ‰å‚æ•°...
    VoiceRecognitionService? voiceRecognitionService,
    VoiceSynthesisService? voiceSynthesisService,
  }) : _voiceRecognitionService = voiceRecognitionService ?? VoiceRecognitionService(),
       _voiceSynthesisService = voiceSynthesisService ?? VoiceSynthesisService(),
       super(GameInitial()) {
    // æ³¨å†Œè¯­éŸ³äº‹ä»¶å¤„ç†å™¨
    on<VoiceControlToggledEvent>(_onVoiceControlToggled);
    on<VoiceCommandReceivedEvent>(_onVoiceCommandReceived);
    on<VoiceAnnouncementRequestedEvent>(_onVoiceAnnouncementRequested);
  }
  
  /// å¤„ç†è¯­éŸ³æ§åˆ¶åˆ‡æ¢
  Future<void> _onVoiceControlToggled(
    VoiceControlToggledEvent event,
    Emitter<GameState> emit,
  ) async {
    if (state is! GamePlaying) return;
    final playing = state as GamePlaying;
    
    if (event.enabled) {
      // åˆå§‹åŒ–å¹¶å¯åŠ¨è¯­éŸ³è¯†åˆ«
      final initialized = await _voiceRecognitionService.initialize();
      
      if (initialized) {
        await _voiceRecognitionService.startListening(
          onResult: (result) {
            if (result.isFinal) {
              add(VoiceCommandReceivedEvent(result.text));
            }
          },
          onError: (error) {
            print('è¯­éŸ³è¯†åˆ«é”™è¯¯: $error');
          },
        );
        
        emit(playing.copyWith(
          isVoiceControlEnabled: true,
          voiceRecognitionStatus: VoiceRecognitionStatus.listening,
        ));
        
        // æ’­æŠ¥æç¤º
        _voiceSynthesisService.speak('è¯­éŸ³æ§åˆ¶å·²å¼€å¯');
      }
    } else {
      // åœæ­¢è¯­éŸ³è¯†åˆ«
      await _voiceRecognitionService.stopListening();
      
      emit(playing.copyWith(
        isVoiceControlEnabled: false,
        voiceRecognitionStatus: VoiceRecognitionStatus.ready,
      ));
      
      _voiceSynthesisService.speak('è¯­éŸ³æ§åˆ¶å·²å…³é—­');
    }
  }
  
  /// å¤„ç†è¯­éŸ³å‘½ä»¤
  Future<void> _onVoiceCommandReceived(
    VoiceCommandReceivedEvent event,
    Emitter<GameState> emit,
  ) async {
    if (state is! GamePlaying) return;
    final playing = state as GamePlaying;
    
    // è§£æè¯­éŸ³å‘½ä»¤
    final position = VoiceCommandParser.parse(event.command);
    
    if (position != null) {
      // è®°å½•å‘½ä»¤
      emit(playing.copyWith(lastVoiceCommand: event.command));
      
      // TODO: æ‰§è¡Œç§»åŠ¨é€»è¾‘
      // éœ€è¦æ ¹æ®å®é™…æ¸¸æˆé€»è¾‘åˆ¤æ–­æ˜¯é€‰ä¸­æ£‹å­è¿˜æ˜¯ç§»åŠ¨æ£‹å­
      
      // æ’­æŠ¥ç¡®è®¤
      final formatted = VoiceCommandParser.formatPosition(position);
      _voiceSynthesisService.speak('å·²è¯†åˆ«: $formatted');
    } else {
      // è¯†åˆ«å¤±è´¥
      _voiceSynthesisService.speak('æœªè¯†åˆ«ï¼Œè¯·é‡æ–°è¯´æ˜');
    }
  }
  
  /// å¤„ç†è¯­éŸ³æ’­æŠ¥è¯·æ±‚
  Future<void> _onVoiceAnnouncementRequested(
    VoiceAnnouncementRequestedEvent event,
    Emitter<GameState> emit,
  ) async {
    await _voiceSynthesisService.speak(event.text);
  }
}
```

### ç¬¬5æ­¥ï¼šUIé›†æˆ

#### 5.1 åœ¨GamePageæ·»åŠ è¯­éŸ³æ§åˆ¶å¼€å…³

ç¼–è¾‘ `lib/ui/screens/game_page.dart`ï¼š

```dart
// åœ¨_buildTopBaræˆ–é€‚å½“ä½ç½®æ·»åŠ 
IconButton(
  icon: Icon(
    isVoiceControlEnabled ? Icons.mic : Icons.mic_off,
    color: isVoiceControlEnabled ? Colors.blue : Colors.grey,
  ),
  onPressed: () {
    final currentState = context.read<GameBloc>().state;
    if (currentState is GamePlaying) {
      context.read<GameBloc>().add(
        VoiceControlToggledEvent(!currentState.isVoiceControlEnabled),
      );
    }
  },
  tooltip: 'è¯­éŸ³æ§åˆ¶',
)
```

#### 5.2 æ˜¾ç¤ºè¯­éŸ³è¯†åˆ«çŠ¶æ€

```dart
// åœ¨é€‚å½“ä½ç½®æ˜¾ç¤º
if (state is GamePlaying && state.isVoiceControlEnabled)
  Container(
    padding: EdgeInsets.all(8),
    decoration: BoxDecoration(
      color: state.voiceRecognitionStatus == VoiceRecognitionStatus.listening
          ? Colors.blue.withOpacity(0.2)
          : Colors.grey.withOpacity(0.1),
      borderRadius: BorderRadius.circular(8),
    ),
    child: Row(
      children: [
        Icon(
          Icons.mic,
          color: state.voiceRecognitionStatus == VoiceRecognitionStatus.listening
              ? Colors.blue
              : Colors.grey,
        ),
        SizedBox(width: 8),
        Text(
          state.voiceRecognitionStatus == VoiceRecognitionStatus.listening
              ? 'æ­£åœ¨ç›‘å¬...'
              : 'è¯­éŸ³å°±ç»ª',
        ),
        if (state.lastVoiceCommand != null)
          Text(' - ${state.lastVoiceCommand}'),
      ],
    ),
  )
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

åˆ›å»º `test/services/voice_command_parser_test.dart`ï¼š

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:foursquare/ai/voice_command_parser.dart';
import 'package:foursquare/models/position.dart';

void main() {
  group('VoiceCommandParser', () {
    test('è§£æä¼ ç»Ÿåæ ‡', () {
      expect(VoiceCommandParser.parse('æ¨ªä¸€ç«–äºŒ'), Position(1, 2));
      expect(VoiceCommandParser.parse('æ¨ª2ç«–3'), Position(2, 3));
    });
    
    test('è§£æå›½é™…åæ ‡', () {
      expect(VoiceCommandParser.parse('A1'), Position(0, 0));
      expect(VoiceCommandParser.parse('B2'), Position(1, 1));
    });
    
    test('è§£ææ–¹å‘åæ ‡', () {
      expect(VoiceCommandParser.parse('å·¦ä¸Š'), Position(0, 0));
      expect(VoiceCommandParser.parse('ä¸­é—´'), Position(1, 1));
    });
    
    test('è§£æè‡ªç„¶è¯­è¨€', () {
      expect(VoiceCommandParser.parse('ç§»åŠ¨åˆ°æ¨ª2ç«–3'), Position(2, 3));
    });
  });
}
```

### æ‰‹å·¥æµ‹è¯•

1. è¿è¡Œåº”ç”¨: `flutter run`
2. è¿›å…¥æ¸¸æˆé¡µé¢
3. ç‚¹å‡»éº¦å…‹é£å›¾æ ‡å¼€å¯è¯­éŸ³æ§åˆ¶
4. å…è®¸éº¦å…‹é£æƒé™
5. è¯´å‡ºæŒ‡ä»¤æµ‹è¯•ï¼š
   - "æ¨ªä¸€ç«–äºŒ"
   - "A1"
   - "å·¦ä¸Š"
   - "ç§»åŠ¨åˆ°æ¨ª2ç«–3"

## ğŸ“š æ”¯æŒçš„è¯­éŸ³æŒ‡ä»¤

| æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| ä¼ ç»Ÿåæ ‡ | "æ¨ªä¸€ç«–äºŒ"ã€"æ¨ª2ç«–3" | æ”¯æŒä¸­æ–‡æ•°å­—å’Œé˜¿æ‹‰ä¼¯æ•°å­— |
| å›½é™…åæ ‡ | "A1"ã€"B2"ã€"C3" | å­—æ¯A-Dï¼Œæ•°å­—1-4 |
| æ–¹å‘åæ ‡ | "å·¦ä¸Š"ã€"å³ä¸‹"ã€"ä¸­é—´" | å¿«æ·æ–¹ä½ |
| è‡ªç„¶è¯­è¨€ | "ç§»åŠ¨åˆ°æ¨ª2ç«–3" | åŒ…å«å…³é”®è¯çš„è‡ªç„¶è¡¨è¾¾ |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æƒé™ç®¡ç†**: é¦–æ¬¡ä½¿ç”¨éœ€è¦è¯·æ±‚éº¦å…‹é£æƒé™
2. **ç½‘ç»œä¾èµ–**: æŸäº›è¯­éŸ³è¯†åˆ«æœåŠ¡éœ€è¦ç½‘ç»œè¿æ¥
3. **è¯†åˆ«å‡†ç¡®ç‡**: å—ç¯å¢ƒå™ªéŸ³å’Œå‘éŸ³æ¸…æ™°åº¦å½±å“
4. **å¤šè¯­è¨€åˆ‡æ¢**: åœ¨è®¾ç½®é¡µé¢æä¾›è¯­è¨€é€‰æ‹©
5. **æ€§èƒ½ä¼˜åŒ–**: é¿å…é¢‘ç¹å¯åœè¯­éŸ³æœåŠ¡

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: è¯­éŸ³è¯†åˆ«æ— å“åº”

**å¯èƒ½åŸå› **:
- éº¦å…‹é£æƒé™æœªæˆäºˆ
- è¯­éŸ³æœåŠ¡æœªåˆå§‹åŒ–

**è§£å†³æ–¹æ¡ˆ**:
```dart
// æ£€æŸ¥æƒé™
bool hasPermission = await VoiceRecognitionService().hasPermission();
if (!hasPermission) {
  // å¼•å¯¼ç”¨æˆ·æˆæƒ
}
```

### é—®é¢˜2: è¯†åˆ«å‡†ç¡®ç‡ä½

**è§£å†³æ–¹æ¡ˆ**:
- æç¤ºç”¨æˆ·åœ¨å®‰é™ç¯å¢ƒä½¿ç”¨
- æä¾›è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹
- å®ç°æ¨¡ç³ŠåŒ¹é…å’Œå€™é€‰åˆ—è¡¨

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [è¯­éŸ³å†¥æƒ³åŠŸèƒ½è®¾è®¡](../docs/design/VOICE_MEDITATION_FEATURE_DESIGN.md)
- [å®Œæ•´è®¾è®¡æ–‡æ¡£](../.qoder/quests/feature-progress-tracking.md)

---

**æœ€åæ›´æ–°**: 2025-11-24  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç»´æŠ¤äººå‘˜**: Qoder AI
