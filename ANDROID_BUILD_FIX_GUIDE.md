# Android构建问题修复指南

<!-- Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-23 -->

## 问题描述

Android构建失败，错误信息：
```
The server may not support the client's requested TLS protocol versions: (TLSv1.2, TLSv1.3)
Remote host terminated the handshake
```

**原因**: 网络环境导致无法访问Maven中央仓库

---

## 解决方案

### 方案1: 使用国内镜像源（推荐）✅

已自动配置阿里云Maven镜像，文件：`android/build.gradle.kts`

```kotlin
allprojects {
    repositories {
        // 国内镜像源（优先）
        maven { url = uri("https://maven.aliyun.com/repository/google") }
        maven { url = uri("https://maven.aliyun.com/repository/jcenter") }
        maven { url = uri("https://maven.aliyun.com/repository/public") }
        maven { url = uri("https://maven.aliyun.com/repository/gradle-plugin") }
        // 官方源（备用）
        google()
        mavenCentral()
    }
}
```

**执行步骤**:
1. 配置已自动完成
2. 清理项目缓存：
   ```bash
   flutter clean
   ```
3. 重新构建：
   ```bash
   flutter build apk --debug
   ```

---

### 方案2: 配置Gradle代理

如果方案1仍然失败，配置HTTP代理。

**创建/编辑文件**: `android/gradle.properties`

添加内容：
```properties
# HTTP代理配置（如果使用代理）
systemProp.http.proxyHost=127.0.0.1
systemProp.http.proxyPort=7890
systemProp.https.proxyHost=127.0.0.1
systemProp.https.proxyPort=7890

# 或使用系统代理
systemProp.http.proxyHost=
systemProp.http.proxyPort=
```

**注意**: 替换为实际代理地址和端口

---

### 方案3: 手动下载Gradle

如果Gradle下载超时，手动下载并配置。

**步骤**:

1. **下载Gradle 8.12**
   - 国内镜像: https://mirrors.cloud.tencent.com/gradle/gradle-8.12-all.zip
   - 官方地址: https://services.gradle.org/distributions/gradle-8.12-all.zip

2. **放置到Gradle缓存目录**
   ```
   C:\Users\<用户名>\.gradle\wrapper\dists\gradle-8.12-all\<hash>\
   ```

3. **解压文件**
   - 解压到该目录
   - 确保有gradle-8.12文件夹

4. **重新构建**
   ```bash
   flutter build apk --debug
   ```

---

### 方案4: 使用本地Gradle

配置项目使用本地Gradle安装。

**编辑文件**: `android/gradle/wrapper/gradle-wrapper.properties`

修改distributionUrl：
```properties
distributionUrl=file\:///D:/tools/gradle-8.12-all.zip
```

**前置条件**: 需要先下载Gradle到本地

---

### 方案5: 降级Gradle版本

使用较低版本的Gradle可能绕过网络问题。

**编辑文件**: `android/gradle/wrapper/gradle-wrapper.properties`

修改为：
```properties
distributionUrl=https\://services.gradle.org/distributions/gradle-7.6.1-all.zip
```

**注意**: 可能需要调整Android Gradle插件版本

---

## 验证步骤

### 1. 清理项目
```bash
cd d:\Develop\outworks\foursquare
flutter clean
```

### 2. 获取依赖
```bash
flutter pub get
```

### 3. 尝试构建
```bash
flutter build apk --debug
```

### 4. 查看详细日志（如果失败）
```bash
flutter build apk --debug --verbose
```

---

## 常见问题

### Q1: 镜像配置后仍然失败

**解决**:
1. 检查网络连接
2. 尝试方案2配置代理
3. 或使用方案3手动下载Gradle

### Q2: Gradle版本不兼容

**症状**: 
```
Could not find method maven() for arguments
```

**解决**:
确保`build.gradle.kts`语法正确：
```kotlin
maven { url = uri("https://...") }  // Kotlin DSL
```

### Q3: 依赖下载缓慢

**解决**:
1. 使用国内镜像（方案1）
2. 配置HTTP代理
3. 耐心等待（首次可能需要10-20分钟）

### Q4: 权限被拒绝

**症状**:
```
Permission denied
```

**解决**:
1. 以管理员运行命令提示符
2. 检查防火墙设置
3. 检查杀毒软件是否阻止

---

## 构建成功标志

成功时应看到：
```
✓ Built build\app\outputs\flutter-apk\app-debug.apk (XX.XMB)
```

APK文件位置：
```
build\app\outputs\flutter-apk\app-debug.apk
```

---

## 后续步骤

构建成功后：

1. **测试APK**
   ```bash
   flutter install
   ```
   或手动安装APK到设备

2. **验证应用**
   - 检查应用图标
   - 检查应用名称（四子游戏）
   - 测试核心功能

3. **构建Release版本**
   ```bash
   flutter build apk --release
   ```

---

## 已配置的优化

✅ **已配置国内镜像源**
- 阿里云Maven镜像
- 加速依赖下载

✅ **应用信息已配置**
- 应用ID: com.qoder.foursquare
- 应用名称: 四子游戏
- 最低SDK: 21

✅ **权限已配置**
- INTERNET（在线功能）
- VIBRATE（触觉反馈）

---

## 需要帮助？

如果以上方案都无法解决问题，请：

1. **收集日志**
   ```bash
   flutter build apk --debug --verbose > build.log 2>&1
   ```

2. **检查环境**
   ```bash
   flutter doctor -v
   ```

3. **检查网络**
   - 尝试访问: https://maven.aliyun.com
   - 检查防火墙和代理设置

4. **备用方案**
   - 使用Web平台发布（已配置完成）
   - 暂时跳过Android，等待网络环境改善

---

**最后更新**: 2025-10-23  
**配置状态**: ✅ 镜像已配置  
**下次构建**: 执行 `flutter build apk --debug`
