// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-11-24
// Task: 实现语音命令解析器

import '../models/position.dart';

/// 语音命令解析器
/// 
/// 负责将语音识别结果解析为游戏指令（Position）
/// 
/// 支持的格式：
/// 1. 传统坐标: "横1竖2"、"横三竖四"
/// 2. 国际式: "A1"、"B2"、"C3"
/// 3. 方向式: "左上"、"右下"、"中间"
/// 4. 自然语言: "移动到横2竖3"
class VoiceCommandParser {
  // 中文数字映射
  static const Map<String, int> _chineseNumbers = {
    '零': 0, '〇': 0,
    '一': 1, '1': 1,
    '二': 2, '2': 2,
    '三': 3, '3': 3,
    '四': 4, '4': 4,
  };

  // 英文字母映射（A-D对应0-3）
  static const Map<String, int> _letterCoords = {
    'A': 0, 'a': 0,
    'B': 1, 'b': 1,
    'C': 2, 'c': 2,
    'D': 3, 'd': 3,
  };

  // 方向坐标映射
  static const Map<String, Position> _directionCoords = {
    '左上': Position(0, 0),
    '右上': Position(3, 0),
    '左下': Position(0, 3),
    '右下': Position(3, 3),
    '中间': Position(1, 1),
    '中心': Position(1, 1),
    '正中': Position(2, 2),
  };

  /// 解析语音指令为Position
  /// 
  /// 返回null表示解析失败
  static Position? parse(String command) {
    if (command.isEmpty) {
      return null;
    }

    // 清理命令（移除空格、标点）
    final cleaned = command
        .replaceAll(' ', '')
        .replaceAll('，', '')
        .replaceAll(',', '')
        .replaceAll('。', '')
        .replaceAll('.', '')
        .toLowerCase();

    // 尝试各种解析方式
    Position? result;

    // 1. 尝试方向解析
    result = _parseDirection(cleaned);
    if (result != null) return result;

    // 2. 尝试传统坐标解析（横X竖Y）
    result = _parseTraditional(cleaned);
    if (result != null) return result;

    // 3. 尝试国际坐标解析（A1, B2等）
    result = _parseInternational(cleaned);
    if (result != null) return result;

    // 4. 尝试自然语言解析
    result = _parseNaturalLanguage(cleaned);
    if (result != null) return result;

    return null;
  }

  /// 解析方向式命令
  static Position? _parseDirection(String command) {
    for (final entry in _directionCoords.entries) {
      if (command.contains(entry.key)) {
        return entry.value;
      }
    }
    return null;
  }

  /// 解析传统坐标（横X竖Y）
  static Position? _parseTraditional(String command) {
    // 匹配"横X竖Y"格式
    final patterns = [
      RegExp(r'横([零〇一二三四1234])竖([零〇一二三四1234])'),
      RegExp(r'行([零〇一二三四1234])列([零〇一二三四1234])'),
    ];

    for (final pattern in patterns) {
      final match = pattern.firstMatch(command);
      if (match != null) {
        final x = _chineseNumbers[match.group(1)] ?? int.tryParse(match.group(1)!);
        final y = _chineseNumbers[match.group(2)] ?? int.tryParse(match.group(2)!);

        if (x != null && y != null && _isValidCoord(x) && _isValidCoord(y)) {
          return Position(x, y);
        }
      }
    }

    return null;
  }

  /// 解析国际坐标（A1, B2等）
  static Position? _parseInternational(String command) {
    final pattern = RegExp(r'([ABCDabcd])([1234])');
    final match = pattern.firstMatch(command);

    if (match != null) {
      final x = _letterCoords[match.group(1)];
      final y = int.tryParse(match.group(2)!) != null
          ? int.parse(match.group(2)!) - 1  // 用户输入1-4，转为0-3
          : null;

      if (x != null && y != null && _isValidCoord(x) && _isValidCoord(y)) {
        return Position(x, y);
      }
    }

    return null;
  }

  /// 解析自然语言
  static Position? _parseNaturalLanguage(String command) {
    // 提取包含坐标的自然语言
    // 例如："移动到横2竖3" -> 提取"横2竖3"
    final keywords = ['移动到', '移到', '走到', '放在', '下在'];

    for (final keyword in keywords) {
      if (command.contains(keyword)) {
        final index = command.indexOf(keyword);
        final coordPart = command.substring(index + keyword.length);

        // 尝试解析提取的部分
        return _parseTraditional(coordPart) ?? _parseInternational(coordPart);
      }
    }

    return null;
  }

  /// 检查坐标是否有效
  static bool _isValidCoord(int coord) {
    return coord >= 0 && coord <= 3;
  }

  /// 模糊匹配
  /// 
  /// 当精确解析失败时，返回可能的候选位置列表
  static List<Position> fuzzyMatch(String command) {
    final candidates = <Position>[];

    // 尝试提取所有可能的数字
    for (int x = 0; x < 4; x++) {
      for (int y = 0; y < 4; y++) {
        // 检查命令中是否包含相关的数字或字母
        final xStr = _getNumberString(x);
        final yStr = _getNumberString(y);

        if (command.contains(xStr) && command.contains(yStr)) {
          candidates.add(Position(x, y));
        }
      }
    }

    return candidates;
  }

  /// 获取数字的字符串表示（包括中文）
  static String _getNumberString(int num) {
    final chineseNum = _chineseNumbers.entries
        .firstWhere((e) => e.value == num, orElse: () => const MapEntry('', -1))
        .key;
    return '$num$chineseNum';
  }

  /// 格式化位置为语音文本（用于播报）
  static String formatPosition(Position position) {
    final x = position.x;
    final y = position.y;

    // 转换为中文数字
    final xChinese = _chineseNumbers.entries
        .firstWhere((e) => e.value == x)
        .key;
    final yChinese = _chineseNumbers.entries
        .firstWhere((e) => e.value == y)
        .key;

    return '横$xChinese竖$yChinese';
  }

  /// 格式化位置为国际坐标（用于显示）
  static String formatPositionInternational(Position position) {
    final letter = _letterCoords.entries
        .firstWhere((e) => e.value == position.x)
        .key
        .toUpperCase();
    final number = position.y + 1;

    return '$letter$number';
  }
}
