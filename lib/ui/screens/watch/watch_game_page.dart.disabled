// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-11-11
// Task: 创建Wear OS手表专用游戏页面，支持小米/OPPO/华为等品牌手表
//
// ====================================================================
// ⚠️ 实验性功能 - 已搁置 (2025-11-24)
// ====================================================================
// 搁置原因: 智能手表平台技术碎片化严重，逐个适配成本过高
// 代码状态: 保留但不纳入主线构建，供未来重启时参考
// 详细说明: 见 lib/ui/screens/watch/README.md
// ====================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../bloc/game_bloc.dart';
import '../../../bloc/game_event.dart';
import '../../../bloc/game_state.dart';
import '../../../models/piece_type.dart';
import '../../../models/position.dart';
import '../../widgets/board_widget.dart';

// Temporary placeholder for WearShape (wear package not available)
enum _WearShape { round, square }
typedef _WatchShapeBuilder = Widget Function(BuildContext, _WearShape, Widget?);
class _WatchShape extends StatelessWidget {
  final _WatchShapeBuilder builder;
  const _WatchShape({super.key, required this.builder});
  @override
  Widget build(BuildContext context) {
    return builder(context, _WearShape.square, null);
  }
}

/// 手表专用游戏页面
/// 
/// 适配设备：
/// - 小米手表（Wear OS）
/// - OPPO Watch（ColorOS Watch基于Wear OS）
/// - vivo Watch（Wear OS）
/// - TicWatch系列
/// - 华为手表（需HarmonyOS特殊处理）
/// 
/// 特性：
/// - 自动检测圆形/方形屏幕
/// - 优化触控区域（≥44dp）
/// - 简化UI，仅保留核心对弈功能
class WatchGamePage extends StatelessWidget {
  final bool isPlayerVsAI;
  final String aiDifficulty;

  const WatchGamePage({
    super.key,
    this.isPlayerVsAI = false,
    this.aiDifficulty = 'easy',
  });

  @override
  Widget build(BuildContext context) {
    return _WatchShape(
      builder: (BuildContext context, _WearShape shape, Widget? child) {
        // 检测屏幕形状
        final isRound = shape == _WearShape.round;
        
        return Scaffold(
          backgroundColor: Colors.black,
          body: SafeArea(
            child: BlocProvider(
              create: (context) => GameBloc()
                ..add(
                  StartGameEvent(
                    isPlayerVsAI: isPlayerVsAI,
                    aiDifficulty: aiDifficulty,
                  ),
                ),
              child: BlocBuilder<GameBloc, GameState>(
                builder: (context, state) {
                  if (state is GameInProgress) {
                    return _buildGameContent(context, state, isRound);
                  } else if (state is GameOver) {
                    return _buildGameOverScreen(context, state, isRound);
                  }
                  return const Center(child: CircularProgressIndicator());
                },
              ),
            ),
          ),
        );
      },
    );
  }

  /// 构建游戏内容（适配圆形/方形屏幕）
  Widget _buildGameContent(BuildContext context, GameInProgress state, bool isRound) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        // 当前玩家指示器（紧凑型）
        _buildCompactPlayerIndicator(state),
        
        const SizedBox(height: 8),
        
        // 棋盘（自动缩放至适合手表屏幕）
        Expanded(
          child: Center(
            child: _buildWatchBoard(context, state, isRound),
          ),
        ),
        
        const SizedBox(height: 8),
        
        // 操作按钮（撤销/重新开始）
        _buildCompactActions(context),
      ],
    );
  }

  /// 紧凑型玩家指示器
  Widget _buildCompactPlayerIndicator(GameInProgress state) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
      decoration: BoxDecoration(
        color: state.currentPlayer == PieceType.black
            ? Colors.grey.shade900
            : Colors.grey.shade100,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            width: 16,
            height: 16,
            decoration: BoxDecoration(
              color: state.currentPlayer == PieceType.black
                  ? Colors.black
                  : Colors.white,
              shape: BoxShape.circle,
              border: Border.all(color: Colors.grey.shade600),
            ),
          ),
          const SizedBox(width: 8),
          Text(
            state.currentPlayer == PieceType.black ? '黑方' : '白方',
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.bold,
              color: state.currentPlayer == PieceType.black
                  ? Colors.white
                  : Colors.black,
            ),
          ),
        ],
      ),
    );
  }

  /// 手表优化棋盘（放大触控区域）
  Widget _buildWatchBoard(BuildContext context, GameInProgress state, bool isRound) {
    final screenSize = MediaQuery.of(context).size;
    final boardSize = screenSize.width * 0.85; // 占屏幕85%
    
    return Container(
      width: boardSize,
      height: boardSize,
      // 圆形屏幕需要特殊裁剪
      decoration: isRound
          ? BoxDecoration(
              shape: BoxShape.circle,
              color: Colors.transparent,
            )
          : null,
      child: BoardWidget(
        boardState: state.boardState,
        selectedPiece: state.selectedPosition,
        validMoves: state.validMoves,
        lastMoveFrom: state.lastMove?.from,
        lastMoveTo: state.lastMove?.to,
        onPositionTapped: (position) {
          context.read<GameBloc>().add(PositionTappedEvent(position));
        },
        // 手表模式：放大棋子尺寸以便点击
        pieceRadiusRatio: 0.42, // 比手机版大（手机是0.35）
      ),
    );
  }

  /// 紧凑型操作按钮
  Widget _buildCompactActions(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        // 撤销按钮
        _buildWatchButton(
          icon: Icons.undo,
          onPressed: () {
            context.read<GameBloc>().add(const UndoMoveEvent());
          },
        ),
        const SizedBox(width: 16),
        // 重新开始按钮
        _buildWatchButton(
          icon: Icons.refresh,
          onPressed: () {
            context.read<GameBloc>().add(
                  StartGameEvent(
                    isPlayerVsAI: isPlayerVsAI,
                    aiDifficulty: aiDifficulty,
                  ),
                );
          },
        ),
      ],
    );
  }

  /// 手表专用按钮（大触控区域）
  Widget _buildWatchButton({
    required IconData icon,
    required VoidCallback onPressed,
  }) {
    return Material(
      color: Colors.grey.shade800,
      shape: const CircleBorder(),
      child: InkWell(
        onTap: onPressed,
        customBorder: const CircleBorder(),
        child: Container(
          width: 44, // 符合Wear OS最小触控尺寸要求
          height: 44,
          alignment: Alignment.center,
          child: Icon(icon, size: 20, color: Colors.white),
        ),
      ),
    );
  }

  /// 游戏结束界面
  Widget _buildGameOverScreen(BuildContext context, GameOver state, bool isRound) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          // 胜利者图标
          Icon(
            Icons.emoji_events,
            size: 48,
            color: state.winner == PieceType.black
                ? Colors.grey.shade700
                : Colors.amber,
          ),
          const SizedBox(height: 16),
          
          // 结果文字
          Text(
            state.winner == null
                ? '平局'
                : state.winner == PieceType.black
                    ? '黑方胜'
                    : '白方胜',
            style: const TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 24),
          
          // 重新开始按钮
          ElevatedButton(
            onPressed: () {
              context.read<GameBloc>().add(
                    StartGameEvent(
                      isPlayerVsAI: isPlayerVsAI,
                      aiDifficulty: aiDifficulty,
                    ),
                  );
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.blue,
              minimumSize: const Size(120, 44),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(22),
              ),
            ),
            child: const Text(
              '再来一局',
              style: TextStyle(fontSize: 14),
            ),
          ),
        ],
      ),
    );
  }
}
