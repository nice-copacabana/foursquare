// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-22
// Task: 实现棋盘Widget，集成BoardPainter并处理用户交互

import 'package:flutter/material.dart';
import '../../models/board_state.dart';
import '../../models/position.dart';
import '../../constants/ui_constants.dart';
import '../../constants/game_constants.dart';
import 'board_painter.dart';

/// 棋盘Widget
/// 
/// 集成BoardPainter进行绘制，并处理用户点击交互
class BoardWidget extends StatelessWidget {
  final BoardState boardState;
  final Position? selectedPiece;
  final List<Position> validMoves;
  final Position? lastMoveFrom;
  final Position? lastMoveTo;
  final Function(Position) onPositionTapped;
  final double? size;
  /// 是否翻转棋盘视角（让白方在下方）
  final bool flipBoard;

  const BoardWidget({
    super.key,
    required this.boardState,
    required this.onPositionTapped,
    this.selectedPiece,
    this.validMoves = const [],
    this.lastMoveFrom,
    this.lastMoveTo,
    this.size,
    this.flipBoard = false,
  });

  @override
  Widget build(BuildContext context) {
    // 计算棋盘尺寸
    final boardSize = size ?? _calculateBoardSize(context);

    Widget boardContent = GestureDetector(
      onTapUp: (details) => _handleTap(details, boardSize),
      child: CustomPaint(
        painter: BoardPainter(
          boardState: boardState,
          selectedPiece: selectedPiece,
          validMoves: validMoves,
          lastMoveFrom: lastMoveFrom,
          lastMoveTo: lastMoveTo,
        ),
        size: Size(boardSize, boardSize),
      ),
    );

    // 如果需要翻转视角，旋转180度
    if (flipBoard) {
      boardContent = Transform.rotate(
        angle: 3.14159, // 180度 = π弧度
        child: boardContent,
      );
    }

    return Center(
      child: RepaintBoundary( // 添加 RepaintBoundary 优化渲染
        child: Container(
          width: boardSize,
          height: boardSize,
          decoration: BoxDecoration(
            boxShadow: [UIConstants.boardShadow],
          ),
          child: boardContent,
        ),
      ),
    );
  }

  /// 计算棋盘尺寸
  double _calculateBoardSize(BuildContext context) {
    final screenSize = MediaQuery.of(context).size;
    final maxSize = screenSize.width < screenSize.height
        ? screenSize.width
        : screenSize.height;

    // 留出边距，取屏幕最小边的指定比例
    return (maxSize * UIConstants.boardScreenRatio).clamp(
      UIConstants.boardMinSize,
      UIConstants.boardMaxSize,
    );
  }

  /// 处理点击事件
  void _handleTap(TapUpDetails details, double boardSize) {
    final cellSize = boardSize / GameConstants.boardSize;
    var localPos = details.localPosition;

    // 如果棋盘已翻转，需要反转坐标
    if (flipBoard) {
      localPos = Offset(
        boardSize - localPos.dx,
        boardSize - localPos.dy,
      );
    }

    // 将屏幕坐标转换为棋盘坐标
    final x = (localPos.dx / cellSize).floor();
    final y = (localPos.dy / cellSize).floor();

    // 检查坐标是否在棋盘范围内
    if (x >= 0 && x < GameConstants.boardSize && y >= 0 && y < GameConstants.boardSize) {
      final position = Position(x, y);
      onPositionTapped(position);
    }
  }
}
